version: '3.4'

services:
    TS_mongo:
        image: mongo
        command:
            - mongod
        expose:
            - ${MONGO_PORT}

    TS:
        image: nhex2/ts
        depends_on:
            - TS_mongo
        expose:
            - "${TS_WS_PORT}"
            - "${TS_HTTP_PORT}"
        ports:
            - "8000:${TS_HTTP_PORT}" # this is just for initiating board on TS
        command:
            ["${TS_WS_PORT}", "${TS_HTTP_PORT}"]

    TSS:
        image: nhex2/tss
        depends_on:
            - TS
        expose:
            - "${TSS_WS_PORT}"
            - "${TSS_HTTP_CONTROL_PORT}"
        ports:
              - "${TSS_WS_PORT}:${TSS_WS_PORT}"
              - "${TSS_HTTP_CONTROL_PORT}:${TSS_HTTP_CONTROL_PORT}"
        command:
            ["${TSS_HTTP_CONTROL_PORT}", "${TSS_WS_PORT}", "TM", "Users"]

    TM_maria:
        image: mariadb
        expose:
            - "${MARIA_PORT}"
        environment:
            MARIADB_ALLOW_EMPTY_ROOT_PASSWORD: true
#            MARIADB_DATABASE: tables
#            MARIADB_ROOT_HOST: TM
        healthcheck:
            test: [ "CMD", "/usr/bin/mysql", "--execute", "SHOW DATABASES;"]
            interval: 5s
            timeout: 1s
            retries: 5
        command:
            "--init-file /data/application/init.sql"
        volumes:
            - ./init.sql:/data/application/init.sql

    TM:
        image: nhex2/tm
        depends_on:
            TM_maria:
                condition: service_healthy
        expose:
            - "${TM_TSS_PORT}"
            - "${TM_APP_PORT}"
        environment:
            TSS_HTTP_CONTROL_PORT: "${TSS_HTTP_CONTROL_PORT}"
            TSS_WS_PORT: "${TSS_WS_PORT}"
            TS_HTTP_PORT: "${TS_HTTP_PORT}"
            TS_WS_PORT: "${TS_WS_PORT}"
            TM_TSS_PORT: "${TM_TSS_PORT}"
            TM_APP_PORT: "${TM_APP_PORT}"
        ports:
            - "6666:${TM_APP_PORT}"

    Users_mongo:
        image: mongo
        command:
            - mongod
        expose:
            - ${MONGO_PORT}

    Users_redis:
        image: redis
        expose:
            - "6379"

    Users:
        image: nhex2/users
        depends_on:
            - Users_mongo
            - Users_redis
        expose:
            - "${USERS_PORT}"
        ports:
            - "2173:${USERS_PORT}"

    Main:
        image: nhex2/main
        depends_on:
            - Users
        environment:
            USERS_URL: "http://Users:${USERS_PORT}"
            TM_URL: "http://TM:${TM_APP_PORT}"
        ports:
            - "2137:${MAIN_PORT}" # this is just for testing
        expose:
            - "${MAIN_PORT}"
